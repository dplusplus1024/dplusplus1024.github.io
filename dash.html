<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>256 Foundation • Hashdash</title>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <style>
    :root{
      --bg0:#070b14;
      --bg1:#0a1024;
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --accent:#38a6ff;
      --good:#39d98a;
      --bad:#ff5b7a;
      --shadow: 0 22px 70px rgba(0,0,0,.55);
      --r:26px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    html,body{
      height:100%;
      margin:0;
      background:
        radial-gradient(1200px 700px at 14% 18%, rgba(56,166,255,.32), transparent 55%),
        radial-gradient(900px 700px at 82% 22%, rgba(140,103,255,.26), transparent 55%),
        radial-gradient(900px 900px at 55% 92%, rgba(37,196,255,.14), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--text);
      font-family: var(--sans);
      overflow-x:hidden;
    }

    a{ color: rgba(170,220,255,.95); text-decoration: none; }
    a:hover{ text-decoration: underline; }

    .wrap{
      max-width: 1240px;
      margin: 0 auto;
      padding: 28px 18px 34px;
    }

    /* HEADER */
    .top{
      display:flex;
      align-items:center;
      gap:16px;
      margin-bottom:18px;
    }

    .logo{
      width:75px;height:75px;border-radius:18px;
      background: #ffffff;
      box-shadow: 0 18px 55px rgba(56,166,255,.25);
      border: 1px solid rgba(255,255,255,.18);
      flex: 0 0 auto;
      object-fit: contain;
      padding: 6px;
      box-sizing: border-box;
    }

    .title{
      display:flex;
      flex-direction:column;
      /* FIX 2: Increased gap to prevent squashing on Desktop */
      gap:10px;
      min-width: 0;
    }

    h1{
      font-size: 34px;
      line-height: 1.05;
      margin:0;
      letter-spacing: .2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .sub{
      display:flex;
      align-items:center;
      gap:10px;
      color:var(--muted);
      font-family: var(--mono);
      font-size: 14px;
      letter-spacing:.2px;
      flex-wrap:wrap;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(12px);
      white-space: nowrap;
    }

    .dot{
      width:8px;height:8px;border-radius:999px;
      background: var(--good);
      box-shadow: 0 0 0 4px rgba(57,217,138,.15);
    }
    .dot.pulse {
      animation: pulse 2s infinite;
    }
    .dot.bad{
      background: var(--bad);
      box-shadow: 0 0 0 4px rgba(255,91,122,.15);
      animation: none;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(57, 217, 138, 0.4); }
      70% { box-shadow: 0 0 0 6px rgba(57, 217, 138, 0); }
      100% { box-shadow: 0 0 0 0 rgba(57, 217, 138, 0); }
    }

    /* GRID SYSTEM */
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:16px;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.075), rgba(255,255,255,.045));
      border: 1px solid rgba(255,255,255,.13);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
      backdrop-filter: blur(16px);
    }

    .card::before{
      content:"";
      position:absolute; inset:-1px;
      background:
        radial-gradient(600px 180px at 30% 0%, rgba(56,166,255,.20), transparent 60%),
        radial-gradient(520px 260px at 92% 12%, rgba(140,103,255,.16), transparent 60%);
      pointer-events:none;
      opacity:.9;
    }

    .cardInner{
      position:relative;
      padding:22px 22px 18px;
    }

    .sectionTitle{
      font-family: var(--mono);
      letter-spacing: .32em;
      text-transform: uppercase;
      font-size: 14px;
      color: rgba(255,255,255,.55);
      margin: 0 0 12px;
    }

    .headRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }

    .meta{
      color: rgba(255,255,255,.50);
      font-family: var(--mono);
      font-size: 15px;
      letter-spacing:.02em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Overview */
    .overview{ grid-column: 1 / -1; }

    .kpiGrid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:16px;
    }

    .kpiTile{
      grid-column: span 3;
      min-height: 118px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      overflow:hidden;
      position: relative;
      transition: transform 0.2s ease, border-color 0.2s ease, background 0.2s ease;
    }
    .kpiTile:hover{
      transform: translateY(-2px);
      border-color: rgba(255,255,255,.25);
      background: rgba(255,255,255,.08);
    }

    .kpiTileInner{ padding:16px 16px 14px; position:relative; z-index:2; }

    .kpiBgIcon{
      position:absolute;
      right: -10px;
      bottom: -10px;
      font-size: 80px;
      color: rgba(255,255,255,.03);
      transform: rotate(-15deg);
      pointer-events: none;
      z-index: 1;
    }

    .kpiTile .label{
      color: rgba(255,255,255,.62);
      font-family: var(--mono);
      font-size: 14px; 
      letter-spacing:.04em;
      margin:0 0 8px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    
    .kpiTile .label i {
      color: var(--accent);
      font-size: 14px;
      opacity: 0.8;
    }

    .kpiTile .value{
      font-weight: 750;
      font-size: 52px;
      line-height: 1;
      margin:0;
      letter-spacing: .5px;
    }

    .kpiTile.small .value{ font-size: 48px; }

    .kpiTile .value .unit{
      font-size: .55em;
      color: rgba(255,255,255,.78);
      margin-left: 8px;
      letter-spacing:.02em;
    }

    /* Charts Row */
    .chartsRow{
      grid-column: 1 / -1;
      display:grid;
      grid-template-columns: 8fr 4fr;
      gap:16px;
    }

    .trendCard{ min-height: 420px; }

    .canvasWrap, .pieWrap{
      position:relative;
      height: 320px;
      margin-top: 8px;
      border-radius: 18px;
      overflow:hidden;
    }

    .canvasWrap{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
    }

    .pieWrap{
      border: none;
      background: transparent;
    }

    .piePad{
      position:absolute;
      inset: 18px;
    }

    canvas{
      display:block;
      width:100% !important;
      height:100% !important;
    }

    /* Users/workers list BELOW */
    .usersCard{
      grid-column: 1 / -1;
      width: 100%;
      max-width: none;
      justify-self: stretch;
    }
    
    .usersContentConstrainer {
      width: 80%;
      margin: 0 auto;
    }

    /* NEW HEADER LAYOUT FOR USERS CARD - FORCE CENTER TITLE + RIGHT TOGGLE */
    .usersHeadRow {
      position: relative; /* Allows absolute positioning of children */
      display: flex;
      justify-content: center; /* Forces Title to center */
      align-items: center;
      margin-bottom: 14px;
      min-height: 32px;
    }
    
    .usersHeadRow .sectionTitle {
      margin: 0; /* Remove default margin to center perfectly */
      white-space: nowrap;
    }
    
    /* Toggle Positioned Absolute Right */
    .toggleContainer {
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      align-items: center;
    }

    .narrowBlock{
      max-width: 980px;
      margin: 0 auto;
    }

    /* =========================
       FILTER BAR
    ========================= */

    .filterBar{
      display:flex;
      align-items:center;
      gap:14px;
      margin: 6px 0 14px;
    }

    .filterField{
      position: relative;
      flex: 1 1 auto;
      min-width: 0;
    }

    .filterField i{
      position:absolute;
      left: 18px;
      top: 50%;
      transform: translateY(-50%);
      color: rgba(255,255,255,.55);
      opacity: .95;
      font-size: 16px;
      pointer-events:none;
    }

    #userFilter{
      width: 100%;
      /* height: 56px; */
      height:45px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.88);
      font-family: var(--mono);
      font-size: 16px;
      padding: 0 18px 0 50px;
      outline: none;
      backdrop-filter: blur(12px);
      box-shadow: 0 14px 44px rgba(0,0,0,.18);
      box-sizing: border-box;
    }

    #userFilter::placeholder{
      color: rgba(255,255,255,.42);
    }

    #userFilter:focus{
      border-color: rgba(56,166,255,.30);
      background: rgba(255,255,255,.075);
    }

    .filterBtn{
      height: 45px;
      padding: 0 22px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(140,103,255,.18);
      color: rgba(255,255,255,.86);
      font-family: var(--mono);
      font-size: 13px;
      letter-spacing: .15em;
      text-transform: uppercase;
      cursor: pointer;
      backdrop-filter: blur(12px);
      box-shadow: 0 14px 44px rgba(0,0,0,.18);
      transition: transform 120ms ease, background 120ms ease, border-color 120ms ease, opacity 120ms ease;
      flex: 0 0 auto;
    }

    .filterBtn:hover{
      background: rgba(140,103,255,.24);
      border-color: rgba(255,255,255,.20);
      transform: translateY(-1px);
    }

    .filterBtn:active{
      transform: translateY(0px) scale(.995);
    }

    .filterBtn:disabled{
      opacity: .45;
      cursor: default;
      transform: none;
    }

    /* Chic Toggle Switch */
    .chicToggle{
      display:flex;
      align-items:center;
      gap:10px;
      cursor:pointer;
      user-select:none;
      font-family: var(--mono);
      font-size:11px;
      letter-spacing: .1em;
      text-transform: uppercase;
      color: rgba(255,255,255,.6);
      flex: 0 0 auto;
      transition: color 0.2s;
    }
    .chicToggle:hover { color: rgba(255,255,255,.9); }
    
    .chicToggle input { display:none; }
    
    .chicToggle .track {
      width: 34px; height: 18px; /* Slightly smaller for header */
      background: rgba(255,255,255,.08);
      border-radius: 99px;
      position: relative;
      transition: background 0.2s ease, border-color 0.2s ease;
      border: 1px solid rgba(255,255,255,.15);
    }
    
    .chicToggle .thumb {
      width: 12px; height: 12px;
      background: rgba(255,255,255,.4);
      border-radius: 50%;
      position: absolute; 
      top: 2px; left: 3px;
      transition: transform 0.2s cubic-bezier(0.4, 0.0, 0.2, 1), background 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,.2);
    }
    
    .chicToggle input:checked + .track {
      background: rgba(56,166,255,.15);
      border-color: var(--accent);
    }
    
    .chicToggle input:checked + .track .thumb {
      transform: translateX(14px);
      background: var(--accent);
      box-shadow: 0 0 8px var(--accent);
    }

    /* SCROLL LIST */
    .list{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top: -10px;
      max-height: 800px;
      overflow-y: auto;
      overflow-x: hidden;
      padding-right: 0;
      scroll-behavior: smooth;
      mask-image: linear-gradient(to bottom, 
        transparent 0%, 
        black 24px, 
        black calc(100% - 24px), 
        transparent 100%
      );
      -webkit-mask-image: linear-gradient(to bottom, 
        transparent 0%, 
        black 24px, 
        black calc(100% - 24px), 
        transparent 100%
      );
      padding-top: 24px;
      padding-bottom: 24px;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    .list::-webkit-scrollbar {
      display: none;
      width: 0;
      height: 0;
    }

    .row{
      padding:12px 12px;
      border-radius: 18px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
    }

    .minerTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .addr{
      font-family: var(--mono);
      font-size: 13px;
      color: rgba(255,255,255,.90);
      white-space: normal;
      overflow-wrap: anywhere;
      cursor: pointer;
      border-radius: 6px;
      padding: 4px 6px;
      margin-left: -6px;
      transition: background 120ms;
    }
    .addr:hover{
      background: rgba(255,255,255,.06);
    }

    .totalHash{
      font-family: var(--mono);
      font-size: 13px;
      color: rgba(255,255,255,.92);
      white-space:nowrap;
      flex: 0 0 auto;
      margin-left: auto;
    }

    /* Workers box */
    .workersWrap{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .workers{
      display:flex;
      flex-direction:column;
      /* TIGHTER SPACING */
      gap:2px;
      padding: 8px 8px;
      border-radius: 16px;
      background: rgba(0,0,0,.14);
      border: 1px solid rgba(255,255,255,.08);
    }

    .workerLine{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-family: var(--mono);
      font-size: 13px;
      color: rgba(255,255,255,.78);
      cursor: pointer;
      /* TIGHTER LINE HEIGHT */
      padding: 3px 6px;
      border-radius: 6px;
      transition: background 0.1s ease;
    }
    .workerLine:hover{
        background: rgba(255,255,255,.06);
        color: rgba(255,255,255,.95);
    }

    .workerLeft{
      display:flex;
      align-items:center;
      gap:8px;
      min-width: 0;
      flex: 1 1 auto;
    }

    .badgeDot{
      width:8px;height:8px;border-radius:999px;
      background: var(--good);
      box-shadow: 0 0 0 4px rgba(57,217,138,.12);
      flex: 0 0 auto;
    }
    .badgeDot.bad{
      background: var(--bad);
      box-shadow: 0 0 0 4px rgba(255,91,122,.12);
    }

    .workerName{
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 620px;
      color: rgba(255,255,255,.82);
    }

    .workerRight{
      display:flex;
      align-items:center;
      gap:10px;
      flex: 0 0 auto;
      white-space: nowrap;
      color: rgba(255,255,255,.62);
    }

    .lastBadge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 4px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.70);
      font-family: var(--mono);
      font-size: 12px;
      white-space: nowrap;
      box-shadow: 0 10px 30px rgba(0,0,0,.12);
    }

    .error{
      color: rgba(255,91,122,.95);
      font-family: var(--mono);
      font-size: 13px;
      margin-top: 12px;
    }

    /* TOOLTIP */
    #hoverTip{
      position: fixed;
      z-index: 9999;
      pointer-events: none;
      opacity: 0;
      /* Remove transform for manual positioning logic */
      transition: opacity 80ms linear;
      background: rgba(0,0,0,.85);
      border: 1px solid rgba(255,255,255,.16);
      border-radius: 12px;
      padding: 10px 14px;
      box-shadow: 0 18px 55px rgba(0,0,0,.6);
      color: rgba(255,255,255,.92);
      font-family: var(--mono);
      font-size: 12px;
      white-space: nowrap;
      backdrop-filter: blur(14px);
    }
    #hoverTip.show{
      opacity: 1;
    }
    #hoverTip .muted{
      color: rgba(255,255,255,.70);
    }

    /* =========================
       DONATIONS
    ========================= */
    .donationsRow{
      grid-column: 1 / -1;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:16px;
    }

    .centerTitle{
      width:100%;
      text-align:center;
    }

    .copyLabel{
      margin: 12px 0 8px;
      color: rgba(255,255,255,.72);
      font-size: 16px;
    }

    .copyField{
      display:flex; 
      justify-content:space-between; 
      align-items:center;
      gap: 12px;
      padding: 14px 16px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.90);
      font-family: var(--mono);
      font-size: 16px;
      overflow-wrap: anywhere;
      cursor: pointer;
      user-select: none;
      transition: transform 90ms ease, background 90ms ease, border-color 90ms ease;
    }

    .copyField i {
        opacity: 0.5;
        font-size: 14px;
    }

    .copyField:hover{
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.16);
    }
    
    .copyField:hover i { opacity: 1; }

    .copyField:active{
      transform: scale(.995);
    }

    /* =========================
       WORKERS TOGGLE
    ========================= */

    .workersExtra{
      overflow:hidden;
      max-height: 980px;
      opacity: 1;
      transform: translateY(0px);
      transition:
        max-height 260ms cubic-bezier(.2,.9,.2,1),
        opacity 180ms ease,
        transform 260ms cubic-bezier(.2,.9,.2,1);
      will-change: max-height, opacity, transform;
      display: flex;
      flex-direction: column;
      /* Matches .workers gap */
      gap: 2px;
    }

    .workers.collapsed .workersExtra{
      max-height: 0px;
      opacity: 0;
      transform: translateY(-6px);
      transition:
        max-height 240ms cubic-bezier(.4,0,.2,1),
        opacity 160ms ease,
        transform 240ms cubic-bezier(.4,0,.2,1);
    }

    .workersToggleRow{
      display:flex;
      justify-content:center;
      padding-top: 6px;
      padding-bottom: 2px;
    }

    .toggleMore{
      appearance:none;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.82);
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing: .22em;
      text-transform: uppercase;
      padding: 8px 14px;
      border-radius: 999px;
      cursor: pointer;
      transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
      backdrop-filter: blur(10px);
      box-shadow: 0 14px 44px rgba(0,0,0,.22);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toggleMore:hover{
      background: rgba(255,255,255,.085);
      border-color: rgba(255,255,255,.20);
      transform: translateY(-1px);
    }

    .toggleMore:active{
      transform: translateY(0px) scale(.995);
    }
    
    .toggleMore i {
        margin-top: -2px; 
    }

    .toggleMore .count{
      letter-spacing: .10em;
      color: rgba(255,255,255,.68);
      margin-left: 0px;
    }

    /* Responsive */
    @media (max-width: 980px){
      .kpiTile{ grid-column: span 6; }
      .chartsRow{ grid-template-columns: 1fr; }
      .workerName{ max-width: 380px; }
      .piePad{ inset: 16px; }
      .narrowBlock{ max-width: 100%; }
      .donationsRow{ grid-template-columns: 1fr; }
      .usersContentConstrainer { width: 100%; }
    }

    /* mobile layout */
    @media (max-width: 620px){
      .list { margin-top: -20px; }

      #filterReset { display: none; }

      /* Header Layout */
      .top {
        align-items: flex-start; /* Aligns logo to top of text */
        gap: 12px;
        margin-bottom: 22px;
      }
      
      /* Resized Logo */
      .logo {
        display: block; /* Unhide */
        width: 48px;
        height: 48px;
        border-radius: 12px; /* Tighter radius for mobile */
        padding: 4px;
        box-shadow: 0 8px 20px rgba(56,166,255,.20); /* Softer shadow */
      }
      
      /* Title area */
      .title {
        min-width: 0;
        flex: 1 1 auto;
      }
      
      h1 { 
        font-size: 22px; /* Balanced size */
        white-space: normal;
        overflow: visible;
        line-height: 1.15;
      }
      
      /* FIX 1: Pills WRAP naturally instead of scrolling off-screen */
      .sub {
        /* margin-top: 8px; */
        flex-wrap: wrap; /* Wrap allows multiple lines */
        gap: 8px; /* Tighter gap for mobile */
      }
      
      /* Make pills slightly more compact */
      .pill {
        font-size: 11px;
        padding: 4px 10px;
        flex: 0 0 auto; /* Don't shrink */
      }

      /* Rest of mobile styles */
      .kpiTile{ grid-column: span 12; }
      .kpiTile .value{ font-size: 54px; }
      .canvasWrap, .pieWrap{ height: 280px; }
      .piePad{ inset: 14px; }
      .trendCard{ min-height: 390px; }
      .totalHash{ margin-left: 0; }
      .addr{ flex-basis: 100%; flex-direction:column; align-items:flex-start; gap:6px; }
      .lastBadge{ display:none; }
      .filterBar{ 
        flex-direction:column; 
        align-items:stretch; 
      }
      .filterField {
        width: 100%;
        margin-bottom: 8px;
      }
      #userFilter{ 
        /* height: 54px;  */
        height:45px;
        width: 100%;
      }
      .filterBtn{ 
        width: 100%; 
        height: 54px; 
        padding: 0 18px; 
      }
      .list{ max-height: 800px; padding-right: 0px; }
      
      /* Toggle on Mobile - Ensure it stays in Header Grid */
      .usersHeadRow {
        margin-bottom: 12px;
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <img src="https://i.imgur.com/Fiot6qk.png" class="logo" alt="256 Foundation">
      <div class="title">
        <h1>256 Foundation &nbsp;<span style="font-size:80%"><i class="fa-solid fa-screwdriver-wrench"></i></span>&nbsp; Hashdash</h1>
        <div class="sub">
          <span class="pill"><span id="statusDot" class="dot pulse"></span><span id="statusText">Connecting</span></span>
          <span class="pill">Powered by <a href="https://hydrapool.org/" target="_blank" rel="noopener noreferrer"><b>Hydra Pool</b></a></span>
          <span class="pill" id="lastUpdate">Last Update: —</span>
        </div>
      </div>
    </div>

    <div class="grid">

      <div class="card overview">
        <div class="cardInner">
          <div class="headRow">
            <div class="sectionTitle">Overview</div>
          </div>

          <div class="kpiGrid">
            <div class="kpiTile">
              <i class="fa-solid fa-bolt kpiBgIcon"></i>
              <div class="kpiTileInner">
                <div class="label"><i class="fa-solid fa-bolt"></i> HASHRATE (5M)</div>
                <div class="value"><span id="hash5m">—</span><span class="unit" id="hash5mUnit"></span></div>
              </div>
            </div>

            <div class="kpiTile small">
              <i class="fa-solid fa-stopwatch kpiBgIcon"></i>
              <div class="kpiTileInner">
                <div class="label"><i class="fa-solid fa-stopwatch"></i> AVG HASHRATE (1H)</div>
                <div class="value"><span id="hash1h">—</span><span class="unit" id="hash1hUnit"></span></div>
              </div>
            </div>

            <div class="kpiTile">
              <i class="fa-solid fa-users kpiBgIcon"></i>
              <div class="kpiTileInner">
                <div class="label"><i class="fa-solid fa-users"></i> ACTIVE USERS</div>
                <div class="value"><span id="usersNow" style="padding-left:20px">—</span><span class="unit"></span></div>
              </div>
            </div>

            <div class="kpiTile">
              <i class="fa-solid fa-microchip kpiBgIcon"></i>
              <div class="kpiTileInner">
                <div class="label"><i class="fa-solid fa-microchip"></i> ACTIVE WORKERS</div>
                <div class="value"><span id="workersOnline" style="padding-left:20px">—</span><span class="unit"></span></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="chartsRow">
        <div class="card trendCard">
          <div class="cardInner">
            <div class="headRow">
              <div class="sectionTitle">Hashrate History</div>
              <div class="meta" id="trendMeta">Last 6h</div>
            </div>

            <div class="canvasWrap">
              <canvas id="trendChart"></canvas>
            </div>
          </div>
        </div>

        <div class="card pieCard">
          <div class="cardInner">
            <div class="headRow">
              <div class="sectionTitle">Miner Share</div>
              <div class="meta" id="pieMeta">Last 5m</div>
            </div>

            <div class="pieWrap">
              <div class="piePad">
                <canvas id="minersPie"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="donationsRow">

        <div class="card">
          <div class="cardInner" style="padding:22px 30px 40px 30px">
            <div class="headRow">
              <div class="sectionTitle centerTitle">Hashrate Donations</div>
            </div>

            <div class="copyLabel">Point your hashrate to:</div>
            <div class="copyField" data-copy="stratum+tcp://pool.256foundation.org:3333">
              <span>stratum+tcp://pool.256foundation.org:3333</span>
              <i class="fa-regular fa-copy"></i>
            </div>

            <div class="copyLabel" style="padding-top:10px">Set your stratum user to bitcoinaddress.workername, e.g.:</div>
            <div class="copyField" data-copy="bc1qce93hy5rhg02s6aeu7mfdvxg76x66pqqtrvzs3.bitaxe69">
              <span>bc1qce93hy5rhg02s6aeu7mfdvxg76x66pqqtrvzs3.bitaxe69</span>
              <i class="fa-regular fa-copy"></i>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="cardInner" style="padding:22px 30px 40px 30px">
            <div class="headRow">
              <div class="sectionTitle centerTitle">Bitcoin Donations</div>
            </div>

            <div class="copyLabel">Send bitcoin directly to:</div>
            <div class="copyField" data-copy="bc1qce93hy5rhg02s6aeu7mfdvxg76x66pqqtrvzs3">
              <span>bc1qce93hy5rhg02s6aeu7mfdvxg76x66pqqtrvzs3</span>
              <i class="fa-regular fa-copy"></i>
            </div>

            <div class="copyLabel" style="padding-top:10px">Or donate via Lightning to:</div>
            <div class="copyField" data-copy="donate@256f.org">
              <span>donate@256f.org</span>
              <i class="fa-regular fa-copy"></i>
            </div>
          </div>
        </div>

      </div>

      <div class="card usersCard">
        <div class="cardInner">
          
          <div class="usersContentConstrainer">
          
            <div class="usersHeadRow">
              <div class="sectionTitle centerTitle">Users + Workers</div>
              <div class="toggleContainer">
                <label class="chicToggle">
                  <input type="checkbox" id="showIdleCheck">
                  <span class="track">
                    <span class="thumb"></span>
                  </span>
                  <span class="label">Show Idle</span>
                </label>
              </div>
            </div>

            <div class="filterBar">
              <div class="filterField">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input id="userFilter" type="text" autocomplete="off" spellcheck="false"
                  placeholder="filter by user / worker" />
              </div>
              <button id="filterReset" type="button" class="filterBtn" disabled>CLEAR</button>
            </div>

            <div class="list" id="usersList"></div>
            <div id="err" class="error"></div>
            
          </div></div>
      </div>

    </div><div class="narrowBlock">
      <div style="text-align:center; margin:0 auto; margin-top:60px">
        <span>Made with ❤️ by <a href="https://x.com/d_plus__plus/" target="_blank"><b>D++</b></a> for the <a href="https://256foundation.org/" target="_blank" rel="noopener noreferrer"><b>256 Foundation</b></a></span>
        <div style="padding-top:4px">Powered by <a href="https://hydrapool.org/" target="_blank" rel="noopener noreferrer"><b>Hydra Pool</b></a></div>
      </div>
    </div>

  </div><div id="hoverTip"></div>

  <script>
    /* =========================
       CONFIG
    ========================= */

    const PROM_BASE = "https://bolt12.dplus.plus/256";

    const TREND_HOURS = 6;
    const TREND_STEP_SECONDS = 60;
    const ONE_HOUR_STEP_SECONDS = 60;

    const FAST_REFRESH_MS = 15 * 1000;
    const TREND_REFRESH_MS = 60 * 1000;

    const MAX_USERS = 18;
    const MAX_WORKERS = 10;
    const PIE_TOP_N = 8;

    // super chic worker collapse
    const WORKERS_COLLAPSED = 3;
    const expandedAddrs = new Set();

    // filter
    let latestUserList = [];
    let filterQuery = "";
    let filterTimer = null;

    const promql = {
      hashrate5m: "sum(rate(worker_shares_valid_total[5m]))",

      usersHashrate5m: "sum by (btcaddress) (rate(worker_shares_valid_total[5m]))",
      usersHashrate5mActiveCount: "count(sum by (btcaddress) (rate(worker_shares_valid_total[5m])) > 0)",

      usersWorkers5m_workername: "sum by (btcaddress, workername) (rate(worker_shares_valid_total[5m]))",
      usersWorkers5m_worker: "sum by (btcaddress, worker) (rate(worker_shares_valid_total[5m]))",
      usersWorkers5m_rig: "sum by (btcaddress, rig) (rate(worker_shares_valid_total[5m]))",
      usersWorkers5m_name: "sum by (btcaddress, name) (rate(worker_shares_valid_total[5m]))",

      lastShare_workername: "max by (btcaddress, workername) (worker_last_share_at)",
      lastShare_worker: "max by (btcaddress, worker) (worker_last_share_at)",
      lastShare_rig: "max by (btcaddress, rig) (worker_last_share_at)",
      lastShare_name: "max by (btcaddress, name) (worker_last_share_at)"
    };

    function isMobile(){
      return window.innerWidth <= 620;
    }

    /* =========================
       PROM API
    ========================= */

    function promQuery(q){
      return $.ajax({
        url: PROM_BASE + "/api/v1/query",
        method: "POST",
        data: "query=" + encodeURIComponent(q),
        contentType: "application/x-www-form-urlencoded; charset=UTF-8"
      });
    }

    function promQueryRange(q, startSec, endSec, stepSec){
      const body =
        "query=" + encodeURIComponent(q) +
        "&start=" + encodeURIComponent(startSec) +
        "&end=" + encodeURIComponent(endSec) +
        "&step=" + encodeURIComponent(stepSec);

      return $.ajax({
        url: PROM_BASE + "/api/v1/query_range",
        method: "POST",
        data: body,
        contentType: "application/x-www-form-urlencoded; charset=UTF-8"
      });
    }

    function okResult(resp){
      return resp && resp.status === "success" && resp.data && resp.data.result;
    }

    function scalarValue(resp){
      if (!okResult(resp)) return NaN;
      const r = resp.data.result;
      if (!r.length || !r[0].value) return NaN;
      const v = parseFloat(r[0].value[1]);
      return isFinite(v) ? v : NaN;
    }

    function series(resp){
      if (!okResult(resp)) return [];
      return resp.data.result || [];
    }

    async function promQueryFirst(list){
      for (let i = 0; i < list.length; i++){
        try{
          const resp = await promQuery(list[i]);
          const s = series(resp);
          if (s && s.length) return { q: list[i], resp: resp };
        } catch(_){}
      }
      return { q: "", resp: null };
    }

    /* =========================
       HELPERS
    ========================= */

    function mean(xs){
      if (!xs || !xs.length) return NaN;
      let s = 0;
      for (let i = 0; i < xs.length; i++) s += xs[i];
      return s / xs.length;
    }

    function median(xs){
      if (!xs || !xs.length) return NaN;
      const a = xs.slice().sort(function(a,b){ return a - b; });
      const mid = Math.floor(a.length / 2);
      if (a.length % 2) return a[mid];
      return (a[mid - 1] + a[mid]) / 2;
    }

    function mad(xs, med){
      if (!xs || !xs.length) return NaN;
      const m = isFinite(med) ? med : median(xs);
      const dev = [];
      for (let i = 0; i < xs.length; i++) dev.push(Math.abs(xs[i] - m));
      return median(dev);
    }

    function fmtInt(n){
      if (!isFinite(n)) return "—";
      return Math.round(n).toLocaleString();
    }

    function toTHs(hPerSec){
      return hPerSec / 1e12;
    }

    function humanHashrateFromHps(hPerSec, decimals = 1){
      if (!isFinite(hPerSec)) return { value: "—", unit: "" };
      const abs = Math.abs(hPerSec);
      if (abs >= 1e15) return { value: (hPerSec / 1e15).toFixed(decimals), unit: "PH/s" };
      if (abs >= 1e12) return { value: (hPerSec / 1e12).toFixed(decimals), unit: "TH/s" };
      if (abs >= 1e9)  return { value: (hPerSec / 1e9).toFixed(decimals), unit: "GH/s" };
      if (abs >= 1e6)  return { value: (hPerSec / 1e6).toFixed(decimals), unit: "MH/s" };
      if (abs >= 1e3)  return { value: (hPerSec / 1e3).toFixed(decimals), unit: "KH/s" };
      return { value: (Math.round(hPerSec * 100) / 100).toString(), unit: "H/s" };
    }

    function fmtTime(tsSec){
      const d = new Date(tsSec * 1000);
      return d.toLocaleTimeString([], { hour:"2-digit", minute:"2-digit" });
    }

    function fmtDateTime(d){
      return d.toLocaleString([], { year:"numeric", month:"numeric", day:"numeric", hour:"numeric", minute:"2-digit", second:"2-digit" });
    }

    function shortAddr(a){
      if (!a) return "—";
      if (a.length <= 16) return a;
      return a.slice(0, 10) + "…" + a.slice(-10);
    }
    
    function superShortAddr(a){
      if (!a) return "—";
      if (a.length <= 12) return a;
      return a.slice(0, 6) + "…" + a.slice(-4);
    }

    function getWorkerName(metric){
      if (!metric) return "";
      if (metric.workername) return metric.workername;
      if (metric.worker) return metric.worker;
      if (metric.rig) return metric.rig;
      if (metric.name) return metric.name;
      return "";
    }

    function niceColorPalette(n){
      const base = [
        "#38a6ff","#8c67ff","#39d98a","#ffd36a","#ff5b7a","#25c4ff",
        "#ff8a3d","#7cf7ff","#b7ff6a","#ff63d8","#7a5cff","#00f5a0",
        "#ffe66a","#ff4d6d","#4de2ff","#9dff57"
      ];
      const out = [];
      for (let i = 0; i < n; i++) out.push(base[i % base.length]);
      return out;
    }

    function escapeHtml(s){
      return String(s || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function applyFilter(list, q){
      const t = String(q || "").trim().toLowerCase();
      if (!t) return list;

      return list.filter(function(u){
        if ((u.addr || "").toLowerCase().includes(t)) return true;
        const ws = u.workers || [];
        for (let i = 0; i < ws.length; i++){
          if ((ws[i].name || "").toLowerCase().includes(t)) return true;
        }
        return false;
      });
    }

    function animateListScrollToRowBottom($row){
      const $scroller = $("#usersList");
      if (!$scroller.length || !$row.length) return;

      const rowTop = $row.position().top;
      const rowBottom = rowTop + $row.outerHeight(true);
      const viewH = $scroller.height();
      const curTop = $scroller.scrollTop();

      const pad = 18;
      const target = Math.max(0, rowBottom - viewH + pad);

      if (target > curTop + 2){
        $scroller.stop(true).animate({ scrollTop: target }, 260);
      }
    }

    /* =========================
       1H AVG FIX
    ========================= */

    async function refreshHash1hFromSamples(){
      const end = Math.floor(Date.now() / 1000);
      const start = end - 3600;

      const resp = await promQueryRange(promql.hashrate5m, start, end, ONE_HOUR_STEP_SECONDS);
      const s = series(resp);
      if (!s.length || !s[0].values || !s[0].values.length) return NaN;

      const xs = s[0].values
        .map(function(v){ return parseFloat(v[1]); })
        .filter(function(v){ return isFinite(v) && v >= 0; });

      if (!xs.length) return NaN;

      const med = median(xs);
      const m = mad(xs, med);

      if (!isFinite(m) || m < 1e-12){
        return toTHs(mean(xs));
      }

      const sigma = m * 1.4826;
      const K = 8;
      const lo = med - K * sigma;
      const hi = med + K * sigma;

      const filtered = xs.filter(function(v){ return v >= lo && v <= hi; });
      const use = filtered.length >= Math.max(6, Math.floor(xs.length * 0.5)) ? filtered : xs;

      return toTHs(mean(use));
    }

    /* =========================
       TREND SMOOTHING
    ========================= */

    function weightedMovingAverage(points) {
      if (!points || points.length < 2) return points;
      const clean = points.filter(p => isFinite(p.v) && p.v >= 0);
      if (clean.length < 2) return clean;
      const windowSize = 3; 
      const out = [];

      for (let i = 0; i < clean.length; i++) {
        let sumW = 0;
        let sumV = 0;
        for (let j = 0; j < windowSize; j++) {
           if (i - j < 0) break;
           const w = windowSize - j;
           sumW += w;
           sumV += clean[i - j].v * w;
        }
        if (sumW > 0) out.push({ t: clean[i].t, v: sumV / sumW });
        else out.push(clean[i]);
      }
      return out;
    }

    /* =========================
       TOOLTIP
    ========================= */

    const $hoverTip = $("#hoverTip");

    function showHoverTip(html, x, y){
      $hoverTip.html(html);

      const pad = 14;
      const tipW = $hoverTip.outerWidth();
      const tipH = $hoverTip.outerHeight();

      let left = x + 14;
      let top = y + 14;

      if (left + tipW + pad > window.innerWidth) left = x - tipW - 14;
      if (top + tipH + pad > window.innerHeight) top = y - tipH - 14;

      $hoverTip.css({ left: left + "px", top: top + "px" }).addClass("show");
    }

    function hideHoverTip(){
      $hoverTip.removeClass("show");
    }

    function wireWorkerHover($el, payload){
      // Mouse listeners for desktop
      $el.on("mouseenter", function(e){
        const html =
          "<div><b>" + escapeHtml(payload.name) + "</b></div>" +
          "<div class='muted'>" + escapeHtml(payload.status) + " • " + escapeHtml(payload.lastTxt) + "</div>";
        showHoverTip(html, e.clientX, e.clientY);
      });

      $el.on("mousemove", function(e){
        const html =
          "<div><b>" + escapeHtml(payload.name) + "</b></div>" +
          "<div class='muted'>" + escapeHtml(payload.status) + " • " + escapeHtml(payload.lastTxt) + "</div>";
        showHoverTip(html, e.clientX, e.clientY);
      });

      $el.on("mouseleave", hideHoverTip);
      
      // Click/Tap listener for Mobile
      $el.on("click", function(e){
        const html =
          "<div><b>" + escapeHtml(payload.name) + "</b></div>" +
          "<div class='muted'>" + escapeHtml(payload.status) + " • " + escapeHtml(payload.lastTxt) + "</div>";
        
        let yPos = e.clientY - 20;
        if(yPos < 0) yPos = 10;

        showHoverTip(html, e.clientX, yPos);
        setTimeout(hideHoverTip, 5000);
      });
    }

    /* =========================
       COPY-TO-CLIPBOARD
    ========================= */

    function pointerXY(e){
      const oe = e && e.originalEvent ? e.originalEvent : e;
      const t = oe && oe.touches && oe.touches.length ? oe.touches[0] : null;
      const x = (typeof e.clientX === "number") ? e.clientX : (t ? t.clientX : Math.floor(window.innerWidth / 2));
      const y = (typeof e.clientY === "number") ? e.clientY : (t ? t.clientY : 90);
      return { x:x, y:y };
    }

    function flashCopiedTip(x, y){
      showHoverTip("<div><b>Copied to clipboard!</b></div>", x, y);
      setTimeout(hideHoverTip, 650);
    }

    function wireCopyFields(){
      $(document).on("click", ".copyField", async function(e){
        const text = $(this).attr("data-copy") || $(this).text();
        const p = pointerXY(e);

        try{
          await navigator.clipboard.writeText(text);
          flashCopiedTip(p.x, p.y);
        } catch(_){
          const $tmp = $("<textarea>").val(text).css({
            position:"fixed", left:"-9999px", top:"-9999px", opacity:"0"
          });
          $("body").append($tmp);
          $tmp[0].select();
          document.execCommand("copy");
          $tmp.remove();
          flashCopiedTip(p.x, p.y);
        }
      });
    }

    /* =========================
       CHARTS
    ========================= */

    let trendChart;
    let minersPie;

    let pieFullAddrs = [];
    let pieTotalTH = 0;

    function initTrendChart(){
      const ctx = document.getElementById("trendChart").getContext("2d");

      function trendGradient(chart){
        const area = chart.chartArea;
        if (!area) return "rgba(56,166,255,0.18)";
        const g = chart.ctx.createLinearGradient(0, area.top, 0, area.bottom);
        g.addColorStop(0, "rgba(56,166,255,0.55)");
        g.addColorStop(1, "rgba(56,166,255,0.00)");
        return g;
      }

      trendChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [{
            label: "Hashrate (TH/s)",
            data: [],
            borderColor: getComputedStyle(document.documentElement).getPropertyValue("--accent").trim(),
            backgroundColor: function(c){
              return trendGradient(c.chart);
            },
            fill: true,
            borderWidth: 2.5,
            pointRadius: 0,
            pointHoverRadius: 6,
            pointHoverBackgroundColor: "#fff",
            tension: 0.25
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          interaction: { mode: "index", intersect: false },
          plugins: {
            legend: {
              labels: {
                color: "rgba(255,255,255,.78)",
                font: { family: getComputedStyle(document.documentElement).getPropertyValue("--mono").trim(), size: 13 },
                padding: 18,
                usePointStyle: true,
                pointStyle: "line"
              }
            },
            tooltip: {
              backgroundColor: "rgba(0,0,0,.72)",
              borderColor: "rgba(255,255,255,.18)",
              borderWidth: 1,
              titleColor: "rgba(255,255,255,.92)",
              bodyColor: "rgba(255,255,255,.92)",
              titleFont: { family: getComputedStyle(document.documentElement).getPropertyValue("--mono").trim(), size: 13 },
              bodyFont: { family: getComputedStyle(document.documentElement).getPropertyValue("--mono").trim(), size: 13 },
              callbacks: {
                label: function(ctx){
                  const v = ctx.parsed.y;
                  return " Hashrate (TH/s): " + (isFinite(v) ? v.toFixed(1) : "—");
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                color: "rgba(255,255,255,.55)",
                maxRotation: 0,
                autoSkip: true,
                autoSkipPadding: 18,
                font: { family: getComputedStyle(document.documentElement).getPropertyValue("--mono").trim(), size: 12 }
              },
              grid: { color: "rgba(255,255,255,.07)" }
            },
            y: {
              ticks: {
                color: "rgba(255,255,255,.55)",
                padding: 8,
                font: { family: getComputedStyle(document.documentElement).getPropertyValue("--mono").trim(), size: 12 },
                callback: function(v){ return v.toFixed ? v.toFixed(0) : v; }
              },
              grid: { color: "rgba(255,255,255,.07)" }
            }
          }
        }
      });
    }

    function setTrendData(pointsTH){
      const labels = [];
      const data = [];

      for (let i = 0; i < pointsTH.length; i++){
        labels.push(new Date(pointsTH[i].t).toLocaleTimeString([], { hour:"2-digit", minute:"2-digit" }));
        data.push(pointsTH[i].v);
      }

      trendChart.data.labels = labels;
      trendChart.data.datasets[0].data = data;
      trendChart.update("none");
    }

    // CUSTOM PIE TOOLTIP HANDLER (External)
    const pieTooltipHandler = (context) => {
      // Tooltip Element
      let tooltipEl = document.getElementById('hoverTip');

      const { chart, tooltip } = context;

      // Hide if no tooltip
      if (tooltip.opacity === 0) {
        tooltipEl.classList.remove('show');
        return;
      }

      // Set Text
      if (tooltip.body) {
        const dataPoints = tooltip.dataPoints;
        if(dataPoints && dataPoints.length > 0) {
          const idx = dataPoints[0].dataIndex;
          const dataset = chart.data.datasets[0];
          
          const rawVal = dataset.data[idx];
          const activeCount = dataset.activeCounts[idx];
          
          const pct = (pieTotalTH > 0) ? ((rawVal / pieTotalTH) * 100) : 0;
          const userTitle = pieFullAddrs[idx] || "";
          
          const plural = activeCount > 1 ? 's' : '';
          
          // Use color dot from the chart data
          const color = dataset.backgroundColor[idx];
          
          // Construct HTML
          // We truncate title via CSS if needed, or handle width
          let innerHtml = `
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
               <div style="width:10px;height:10px;border-radius:50%;background:${color};box-shadow:0 0 6px ${color};"></div>
               <div style="font-weight:700;font-size:13px;max-width:310px; overflow:hidden;text-overflow:ellipsis;">${escapeHtml(userTitle)}</div>
            </div>
            <div class="muted">
               ${rawVal.toFixed(2)} TH/s • ${pct.toFixed(1)}% • ${activeCount} active worker${plural}
            </div>
          `;
          
          tooltipEl.innerHTML = innerHtml;
        }
      }

      // Position logic (Responsive Clamping)
      const rect = chart.canvas.getBoundingClientRect();
      const tipW = tooltipEl.offsetWidth;
      const tipH = tooltipEl.offsetHeight;
      const pad = 12;

      // Target position: caretX/Y are relative to chart canvas area
      let left = rect.left + tooltip.caretX + 14; 
      let top = rect.top + tooltip.caretY;

      // Clamp to viewport
      // If goes off right edge, flip to left
      if (left + tipW + pad > window.innerWidth) {
         left = rect.left + tooltip.caretX - tipW - 14;
      }
      // If goes off left edge (after flipping or initially), clamp to 10px
      if (left < 10) left = 10;
      
      // If goes off bottom, flip up
      if (top + tipH + pad > window.innerHeight) {
         top = rect.top + tooltip.caretY - tipH - 10;
      }

      tooltipEl.style.left = left + 'px';
      tooltipEl.style.top = top + 'px';
      tooltipEl.classList.add('show');
    };

    function initMinersPie(){
      const ctx = document.getElementById("minersPie").getContext("2d");
      minersPie = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: [],
          datasets: [{
            data: [],
            activeCounts: [], 
            backgroundColor: [],
            borderColor: "rgba(255,255,255,.10)",
            borderWidth: 1,
            hoverOffset: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          cutout: "64%",
          plugins: {
            legend: {
              display: false,
              position: "bottom",
              title: {
                display: true,
                text: " ",   // A space forces the block to render
                padding: 4  ,  // The text height itself (~12px) acts as the 10px spacer
              },

              onClick: function(e, legendItem, legend) {
                 const index = legendItem.index;
                 const chart = legend.chart;
                 if(chart.tooltip) {
                     chart.tooltip.setActiveElements([{datasetIndex: 0, index: index}], {x: 0, y: 0});
                     chart.update();
                 }
              },
              labels: {
                color: "rgba(255,255,255,.78)",
                font: { family: getComputedStyle(document.documentElement).getPropertyValue("--mono").trim(), size: 11 },
                padding: 10,
                usePointStyle: true,
                pointStyle: "circle"
              }
            },
            tooltip: {
              enabled: false, // Use custom handler
              external: pieTooltipHandler
            }
          }
        }
      });
    }

    function setPieLegendForViewport(){
      const mobile = isMobile();
      if (minersPie){
        minersPie.options.plugins.legend.display = mobile;
        minersPie.update("none");
      }
    }

    function setPieData(minersSorted){
      const labels = [];
      const valsTH = [];
      const activeCounts = [];
      pieFullAddrs = [];

      const top = minersSorted.slice(0, PIE_TOP_N);
      let otherHps = 0;
      let otherActive = 0;

      for (let i = PIE_TOP_N; i < minersSorted.length; i++){
        otherHps += minersSorted[i].totalHps;
        const workers = minersSorted[i].workers || [];
        for(let w=0; w<workers.length; w++) {
           if(workers[w].active) otherActive++;
        }
      }

      for (let j = 0; j < top.length; j++){
        labels.push(isMobile() ? superShortAddr(top[j].addr) : shortAddr(top[j].addr));
        pieFullAddrs.push(top[j].addr);
        valsTH.push(toTHs(top[j].totalHps));
        
        let active = 0;
        const workers = top[j].workers || [];
        for(let w=0; w<workers.length; w++) {
           if(workers[w].active) active++;
        }
        activeCounts.push(active);
      }

      if (minersSorted.length > PIE_TOP_N){
        labels.push("other");
        pieFullAddrs.push("other");
        valsTH.push(toTHs(otherHps));
        activeCounts.push(otherActive);
      }

      pieTotalTH = 0;
      for (let k = 0; k < valsTH.length; k++) pieTotalTH += valsTH[k];

      const colors = niceColorPalette(labels.length);

      minersPie.data.labels = labels;
      minersPie.data.datasets[0].data = valsTH;
      minersPie.data.datasets[0].backgroundColor = colors;
      minersPie.data.datasets[0].activeCounts = activeCounts;
      minersPie.update("none");
    }

    /* =========================
       RENDER USERS LIST
    ========================= */

    function renderUsersList(list){

      const $list = $("#usersList");
      $list.empty();

      // Check current toggle state
      const showIdle = $("#showIdleCheck").is(":checked");
      const isFiltering = filterQuery.length > 0;
      
      // LOGIC: If filtered by search, always show matches regardless of idle status.
      // Otherwise, respect the toggle.
      const effectiveShowIdle = showIdle || isFiltering;

      // 1. First, create a filtered copy of the list based on IDLE preferences
      // We must filter the WORKERS inside each user first.
      const processedUsers = [];

      for(let i=0; i<list.length; i++) {
          const user = list[i];
          const allWorkers = user.workers || [];
          
          // Filter workers based on idle setting
          const visibleWorkers = allWorkers.filter(w => effectiveShowIdle || w.active);
          
          // If we are hiding idle, and this user has NO visible workers, skip user completely.
          // Exception: If searching (isFiltering), applyFilter will handle matches, 
          // so we pass the user along if they have matched active workers.
          if (!effectiveShowIdle && visibleWorkers.length === 0) {
             continue; 
          }
          
          // Clone user object to avoid mutating original, attach filtered workers
          const processedUser = Object.assign({}, user);
          processedUser.workers = visibleWorkers;
          
          // Sort workers: Active first, then by hashrate
          processedUser.workers.sort(function(a,b){ 
             if(a.active && !b.active) return -1;
             if(!a.active && b.active) return 1;
             return b.hps - a.hps; 
          });
          
          processedUsers.push(processedUser);
      }

      // 2. Apply Text Filter (Search)
      const filtered = applyFilter(processedUsers, filterQuery);
      
      // 3. Slice Top N
      const topUsers = filtered.slice(0, MAX_USERS);

      for (let n = 0; n < topUsers.length; n++){
        const addr = topUsers[n].addr;
        const totalHps = topUsers[n].totalHps;
        // User Total: 1 decimal
        const totalHr = humanHashrateFromHps(totalHps, 1);
        
        // Count active workers (from original user data, to show correct stats?)
        // Or from visible? Let's count from visible to be consistent with view.
        let activeCount = 0;
        const ws = topUsers[n].workers;
        for(let w=0; w<ws.length; w++) if(ws[w].active) activeCount++;

        const $row = $("<div>").addClass("row");

        const $top = $("<div>").addClass("minerTop");
        const $addr = $("<div>").addClass("addr").text(addr);
        
        // Add hover tooltip for Active Worker Count
        $addr.on("mouseenter", function(e){
            const txt = activeCount === 1 ? "1 active worker" : (activeCount + " active workers");
            showHoverTip(`<div><b>${txt}</b></div>`, e.clientX, e.clientY);
        }).on("mouseleave", hideHoverTip);
        
        // Add tap tooltip for Mobile
        $addr.on("click", function(e){
            const txt = activeCount === 1 ? "1 active worker" : (activeCount + " active workers");
            showHoverTip(`<div><b>${txt}</b></div>`, e.clientX, e.clientY - 20);
            setTimeout(hideHoverTip, 2500);
        });

        const $hash = $("<div>").addClass("totalHash").text(totalHr.value + " " + totalHr.unit);
        $top.append($addr, $hash);

        const $wrap = $("<div>").addClass("workersWrap");
        const $workers = $("<div>").addClass("workers");
        const $extra = $("<div>").addClass("workersExtra");

        // If filtering, ignore MAX_WORKERS cap so we can see the deep results
        // Also if we have filtered specifically for idle, we might have fewer workers anyway
        const workersToShow = isFiltering ? ws : ws.slice(0, MAX_WORKERS);
        
        // CRITICAL FIX: If filtering, never collapse
        const shouldCollapse = !isFiltering && (workersToShow.length > WORKERS_COLLAPSED) && !expandedAddrs.has(addr);
        
        if (shouldCollapse) $workers.addClass("collapsed");

        if (workersToShow.length){
          for (let j = 0; j < workersToShow.length; j++){
            // Worker Rate: 0 decimals
            const wh = humanHashrateFromHps(workersToShow[j].hps, 0);

            const status = workersToShow[j].active ? "active" : "idle";
            const lastTxt = isFinite(workersToShow[j].last) ? ("last share: " + fmtTime(workersToShow[j].last)) : "last: —";

            const $line = $("<div>").addClass("workerLine");

            const $left = $("<div>").addClass("workerLeft");
            const $dot = $("<span>").addClass("badgeDot").toggleClass("bad", !workersToShow[j].active);
            const $name = $("<div>").addClass("workerName").text(workersToShow[j].name);
            $left.append($dot, $name);

            const $right = $("<div>").addClass("workerRight");
            const $rate = $("<span>").text(wh.value + " " + wh.unit);
            const $last = $("<span>").addClass("lastBadge").text(lastTxt);

            if (isMobile()){
              if (workersToShow[j].active){
                $right.append($rate);
              } else {
                $last.addClass("showMobile");
                $right.append($rate, $last);
              }
            } else {
              $right.append($rate, $last);
            }

            $line.append($left, $right);

            if (j < WORKERS_COLLAPSED) $workers.append($line);
            else $extra.append($line);

            // CRITICAL FIX: Ensure hover logic is attached to every line
            wireWorkerHover($line, { status: status, lastTxt: lastTxt, name: workersToShow[j].name });
          }

          if (workersToShow.length > WORKERS_COLLAPSED){
            $workers.append($extra);
            const hiddenCount = workersToShow.length - WORKERS_COLLAPSED;

            // Only show toggle if NOT filtering (auto-expanded when filtering)
            if (!isFiltering) {
                const $toggleRow = $("<div>").addClass("workersToggleRow");
                const $btn = $("<button>").attr("type", "button").addClass("toggleMore");
    
                function renderToggle(){
                  const open = expandedAddrs.has(addr);
                  if (open){
                    $btn.html(`VIEW LESS <i class='fa-solid fa-caret-up'></i>`);
                  } else {
                    $btn.html(`VIEW <span class='count'>${hiddenCount}</span> MORE <i class='fa-solid fa-caret-down'></i>`);
                  }
                }
    
                renderToggle();
    
                $btn.on("click", function(){
                  hideHoverTip();
    
                  const $scroller = $("#usersList");
                  const wasOpen = expandedAddrs.has(addr);
    
                  if (wasOpen) expandedAddrs.delete(addr);
                  else expandedAddrs.add(addr);
    
                  $workers.toggleClass("collapsed", !expandedAddrs.has(addr));
                  renderToggle();
    
                  if (!wasOpen){
                    requestAnimationFrame(function(){
                      animateListScrollToRowBottom($row);
                    });
                  }
                });
    
                $toggleRow.append($btn);
                $wrap.append($workers, $toggleRow);
            } else {
                $wrap.append($workers);
            }
          } else {
            $wrap.append($workers);
          }

        } else {
          const $line = $("<div>").addClass("workerLine");
          const $left = $("<div>").addClass("workerLeft");
          const $dot = $("<span>").addClass("badgeDot bad");
          const $name = $("<div>").addClass("workerName").text("— no workers found —");
          $left.append($dot, $name);
          const $right = $("<div>").addClass("workerRight").text("");
          $line.append($left, $right);
          $workers.append($line);
          $wrap.append($workers);
        }

        $row.append($top, $wrap);
        $list.append($row);
        
      }

      if (filterQuery && !topUsers.length){
        const $empty = $("<div>").addClass("row").css({ textAlign:"center", padding:"18px 12px" })
          .text("No matches for: " + filterQuery);
        $list.append($empty);
      }
    }

    /* =========================
       REFRESH
    ========================= */

    async function refreshOverview(){
      $("#err").text("");

      try{
        const upResp = await promQuery("up");
        const online = (scalarValue(upResp) === 1);

        $("#statusDot").toggleClass("bad", !online);
        $("#statusText").text(online ? "Online" : "Offline");

        const hash5mResp = await promQuery(promql.hashrate5m);
        const hash5mHps = scalarValue(hash5mResp);

        const hr = humanHashrateFromHps(hash5mHps);
        $("#hash5m").text(hr.value);
        $("#hash5mUnit").text(hr.unit);

        const hash1hTH = await refreshHash1hFromSamples();
        if (isFinite(hash1hTH)){
          const hr1 = humanHashrateFromHps(hash1hTH * 1e12);
          $("#hash1h").text(hr1.value);
          $("#hash1hUnit").text(hr1.unit);
        } else {
          $("#hash1h").text("—");
          $("#hash1hUnit").text("");
        }

        const usersNowResp = await promQuery(promql.usersHashrate5mActiveCount);
        $("#usersNow").text(fmtInt(scalarValue(usersNowResp)));

        const now = new Date();
        $("#lastUpdate").text("Last Update: " + fmtDateTime(now));

      } catch (e){
        $("#statusDot").addClass("bad");
        $("#statusText").text("error");
        $("#err").text("overview error: " + (e?.statusText || e?.message || "unknown"));
      }
    }

    async function refreshUsersWorkersAndPie(){
      $("#err").text("");

      try{
        const totalsResp = await promQuery(promql.usersHashrate5m);
        const totalsSeries = series(totalsResp);

        const workersPick = await promQueryFirst([
          promql.usersWorkers5m_workername,
          promql.usersWorkers5m_worker,
          promql.usersWorkers5m_rig,
          promql.usersWorkers5m_name
        ]);
        const workersSeries = workersPick.resp ? series(workersPick.resp) : [];

        const lastPick = await promQueryFirst([
          promql.lastShare_workername,
          promql.lastShare_worker,
          promql.lastShare_rig,
          promql.lastShare_name
        ]);
        const lastSeries = lastPick.resp ? series(lastPick.resp) : [];

        const lastMap = {};
        for (let i = 0; i < lastSeries.length; i++){
          const metric = lastSeries[i].metric || {};
          const addr = metric.btcaddress || "";
          const w = getWorkerName(metric);
          const t = lastSeries[i].value ? parseFloat(lastSeries[i].value[1]) : NaN;
          if (!addr || !w || !isFinite(t)) continue;
          lastMap[addr + "|" + w] = t;
        }

        const nowSec = Math.floor(Date.now() / 1000);

        const users = {};

        for (let i = 0; i < totalsSeries.length; i++){
          const addr = totalsSeries[i].metric?.btcaddress || "";
          const v = totalsSeries[i].value ? parseFloat(totalsSeries[i].value[1]) : NaN;
          if (!addr || !isFinite(v)) continue;
          if (!users[addr]) users[addr] = { addr: addr, totalHps: 0, workers: [] };
          users[addr].totalHps = v;
        }

        for (let k = 0; k < workersSeries.length; k++){
          const metric = workersSeries[k].metric || {};
          const addr = metric.btcaddress || "";
          const wName = getWorkerName(metric);
          const v = workersSeries[k].value ? parseFloat(workersSeries[k].value[1]) : NaN;
          if (!addr || !wName || !isFinite(v)) continue;

          if (!users[addr]) users[addr] = { addr: addr, totalHps: 0, workers: [] };

          const last = lastMap[addr + "|" + wName];
          const active = isFinite(last) ? ((nowSec - last) <= 300) : (v > 0);

          users[addr].workers.push({ name: wName, hps: v, last: last, active: active });
        }

        const userList = [];
        for (const a in users) userList.push(users[a]);
        userList.sort(function(a,b){ return b.totalHps - a.totalHps; });

        latestUserList = userList.slice();

        setPieData(userList);

        let workersOnlineNow = 0;
        for (let m = 0; m < userList.length; m++){
          for (let w = 0; w < userList[m].workers.length; w++){
            if (userList[m].workers[w].active) workersOnlineNow++;
          }
        }
        $("#workersOnline").text(fmtInt(workersOnlineNow));

        renderUsersList(latestUserList);

      } catch (e){
        $("#err").text("users/workers error: " + (e?.statusText || e?.message || "unknown"));
      }
    }

    async function refreshTrend(){
      $("#err").text("");

      try{
        const end = Math.floor(Date.now() / 1000);
        const start = end - (TREND_HOURS * 3600);

        const resp = await promQueryRange(promql.hashrate5m, start, end, TREND_STEP_SECONDS);
        const s = series(resp);
        if (!s.length || !s[0].values || !s[0].values.length){
          setTrendData([]);
          return;
        }

        const raw = [];
        for (let i = 0; i < s[0].values.length; i++){
          const ts = s[0].values[i][0];
          const v = parseFloat(s[0].values[i][1]);
          if (!isFinite(v) || v < 0) continue;
          raw.push({ t: ts * 1000, v: v });
        }

        const smooth = weightedMovingAverage(raw);

        const smoothTH = [];
        for (let j = 0; j < smooth.length; j++){
          smoothTH.push({ t: smooth[j].t, v: toTHs(smooth[j].v) });
        }

        setTrendData(smoothTH);

      } catch (e){
        $("#err").text("trend error: " + (e?.statusText || e?.message || "unknown"));
      }
    }

    /* =========================
       FILTER UI
    ========================= */

    function wireFilter(){
      function applyNow(){
        filterQuery = String($("#userFilter").val() || "").trim();
        $("#filterReset").prop("disabled", !filterQuery.length);
        renderUsersList(latestUserList);
      }

      $("#userFilter").on("input", function(){
        clearTimeout(filterTimer);
        filterTimer = setTimeout(applyNow, 80);
      });

      $("#userFilter").on("keydown", function(e){
        if (e.key === "Escape"){
          $(this).val("");
          filterQuery = "";
          $("#filterReset").prop("disabled", true);
          renderUsersList(latestUserList);
        }
      });

      $("#filterReset").on("click", function(){
        $("#userFilter").val("");
        filterQuery = "";
        $(this).prop("disabled", true);
        renderUsersList(latestUserList);
      });
      
      // Wire Toggle
      $("#showIdleCheck").on("change", function(){
         renderUsersList(latestUserList);
      });
    }

    /* =========================
       BOOT
    ========================= */

    let lastTrendAt = 0;

    async function refreshAll(forceTrend){
      await refreshOverview();
      await refreshUsersWorkersAndPie();

      const now = Date.now();
      if (forceTrend || (now - lastTrendAt > TREND_REFRESH_MS)){
        lastTrendAt = now;
        await refreshTrend();
      }
    }

    $(function(){
      initTrendChart();
      initMinersPie();
      setPieLegendForViewport();
      wireCopyFields();
      wireFilter();

      window.addEventListener("resize", function(){
        setPieLegendForViewport();
      });

      document.addEventListener("scroll", hideHoverTip, { passive: true });

      refreshAll(true);

      setInterval(function(){
        refreshAll(false);
      }, FAST_REFRESH_MS);
    });
  </script>
</body>
</html>
